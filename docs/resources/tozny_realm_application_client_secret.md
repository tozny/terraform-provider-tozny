# tozny_realm_application_client_secret Resource

Resource for provisioning a TozID Application OIDC Client Secret for integrating an OIDC application with TozID.

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage
```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local filebased credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning a token that can be used to register Tozny clients
# such as a realm broker identity
resource "tozny_client_registration_token" "realm_registration_token" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  name = "${tozny_realm.my_organizations_realm.realm_name}DefaultClientRegistrationToken"
  allowed_registration_client_types = ["general", "identity", "broker"]
  enabled = true
  one_time_use = false
}

# A resource for provisioning an identity that can be used to delegate authority for
# realm activities such as email recovery
resource "tozny_realm_broker_identity" "broker_identity" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  client_registration_token = tozny_client_registration_token.realm_registration_token.token
  realm_name = tozny_realm.my_organizations_realm.realm_name
  name = "broker${tozny_realm.my_organizations_realm.realm_name}"
  broker_identity_credentials_save_filepath = "./${tozny_realm.my_organizations_realm.realm_name}_broker_identity_credentials.json"
}

# A resource for delegating authority to another Tozny client
# (either hosted by Tozny or some other third party) to broker realm
# activities (such as email recovery).
resource "tozny_realm_broker_delegation" "allow_tozny_hosted_brokering_policy" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm_broker_identity.broker_identity,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_broker_identity_credentials_filepath = "./${tozny_realm.my_organizations_realm.realm_name}_broker_identity_credentials.json"
  use_tozny_hosted_broker = true
}

# A resource for creating an OIDC based realm application
resource "tozny_realm_application" "jenkins_oidc_application" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm.my_organizations_realm,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  client_id = "jenkins-oid-app"
  name = "Jenkins"
  active = true
  protocol = "openid-connect"
  oidc_settings {
    allowed_origins = [ "https://jenkins.acme.com/allowed" ]
    access_type = "bearer-only"
    root_url = "https://jenkins.acme.com"
    standard_flow_enabled = true
    base_url = "https://jenkins.acme.com/baseurl"

  }
}

# A resource for retrieving the OIDC client secret for an application
# this resource is configured to bypass storing the secret in terraform
# but instead to a local file that can be secured and accessed outside of terraform
resource "tozny_realm_application_client_secret" "jenkins_oidc_client_secret_file_only" {
  depends_on = [
    tozny_realm.my_organizations_realm,
    tozny_realm_application.jenkins_oidc_application,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  application_id = tozny_realm_application.jenkins_oidc_application.application_id
  persist_client_secret_to_terraform = false
  client_secret_save_filepath = "./client_secret_file_only.txt"
}

# A resource for retrieving the OIDC client secret for an application
# this resource is configured to store the secret in terraform
# so it can be accessed by other terraform resources
resource "tozny_realm_application_client_secret" "jenkins_oidc_client_secret_terraform_only" {
  depends_on = [
    tozny_realm.my_organizations_realm,
    tozny_realm_application.jenkins_oidc_application,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  application_id = tozny_realm_application.jenkins_oidc_application.application_id
  persist_client_secret_to_terraform = true
}

# A resource for retrieving the OIDC client secret for an application
# this resource is configured to store the secret in terraform
# so it can be accessed by other terraform resources as well as
# to a local file that can be secured and accessed outside of terraform
resource "tozny_realm_application_client_secret" "jenkins_oidc_client_secret_terraform_and_file" {
  depends_on = [
    tozny_realm.my_organizations_realm,
    tozny_realm_application.jenkins_oidc_application,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  application_id = tozny_realm_application.jenkins_oidc_application.application_id
  persist_client_secret_to_terraform = true
  client_secret_save_filepath = "./client_secret_file_and_terraform.txt"
}
```

## Argument Reference

### Top-Level Arguments

* `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the Terraform provider to use when provisioning this application client secret.
* `secret` - (Computed) OIDC Client secret for the application. Will always be empty if `persist_client_secret_to_terraform` is `false`.
* `application_id` - (Required) The application ID to retrieve the client secret for.
* `realm_name` - (Required) The name of the realm the application is associated with.
* `persist_client_secret_to_terraform` - (Optional) Whether or not the client secret should be persisted to terraform. Defaults to true.
* `client_secret_save_filepath` - (Optional) The filepath to save the client secret to. If not specified the secret will not be saved to the filesystem.

## Attribute Reference

* `id` - Terraform defined unique id for the resource.
