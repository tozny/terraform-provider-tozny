# tozny_shadow_realm_federation Resource

## Example Usage

```hcl
# Configure the Terraform runtime
terraform {
  required_version = ">= 0.14"
  required_providers {
    tozny = {
      # Pull signed provider binaries from
      # the Terraform hosted registry namespace
      # for Tozny registry.terraform.io/tozny
      source = "tozny/tozny"
      # Pin Tozny provider version
      version = ">=0.14.0"
    }
  }
}

# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint     = "http://platform.local.tozny.com:8000"
  account_username = "test@tozny.com"
}


# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  persist_credentials_to           = "terraform"
}


# A resource for provisioning a token that can be used to register Tozny clients
# such as a realm broker identity
resource "tozny_client_registration_token" "realm_registration_token" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_config         = tozny_account.autogenerated_tozny_account.config
  name                              = "RealmDefaultClientRegistrationToken"
  allowed_registration_client_types = ["general", "identity", "broker"]
  enabled                           = true
  one_time_use                      = false
}

# A resource for provisioning a TozID Realm
# using local file based credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_client_registration_token.realm_registration_token
  ]
  client_credentials_config  = tozny_account.autogenerated_tozny_account.config
  default_registration_token = tozny_client_registration_token.realm_registration_token.token
  realm_name                 = "realmName"
  sovereign_name             = "Administrator"
  tozid_federation_enabled   = true
}
# A resource for provisioning an identity that can be used to delegate authority for
# realm activities such as email recovery
resource "tozny_realm_broker_identity" "broker_identity" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_client_registration_token.realm_registration_token
  ]
  client_credentials_config = tozny_account.autogenerated_tozny_account.config
  client_registration_token = tozny_client_registration_token.realm_registration_token.token
  realm_name                = tozny_realm.my_organizations_realm.realm_name
  name                      = "broker${tozny_realm.my_organizations_realm.realm_name}"
  persist_credentials_to    = "terraform"
  # broker_identity_credentials_save_filepath = "./${tozny_realm.my_organizations_realm.realm_name}_broker_identity_credentials.json"
}

# A resource for delegating authority to another Tozny client
# (either hosted by Tozny or some other third party) to broker realm
# activities (such as email recovery).
resource "tozny_realm_broker_delegation" "allow_tozny_hosted_brokering_policy" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm_broker_identity.broker_identity,
  ]
  client_credentials_config = tozny_account.autogenerated_tozny_account.config
  realm_broker_identity_credentials = tozny_realm_broker_identity.broker_identity.credentials
  use_tozny_hosted_broker = true
}

# A resource for connecting to a federating Tozny Primary Realm
resource "tozny_shadow_realm_federation" "testfederation" {
  depends_on = [
    tozny_realm.my_organizations_realm
  ]
   client_credentials_config  = tozny_account.autogenerated_tozny_account.config
  federation_source      = "tozid"
  realm_name             = tozny_realm.my_organizations_realm.realm_name
  primary_realm_name     = "primaryRealmName"
  api_credential         = "apiCredential"
  primary_realm_endpoint = "https://dev.e3db.com"
  active                 = true
  sync                   = true
  connection_id          = "99452d2e-8193-4efc-8a25-3f2e3929dcdf"
}
```

## Argument Reference

### Top-Level Arguments

- `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the provider to use when provisioning this realm. Omit if using `client_credentials_config`.
- `client_credentials_config` - (Optional) A JSON string containing Tozny client credentials for the provider to use when provisioning this realm. Omit if using `client_credentials_filepath`.
- `realm_name` - (Required) User defined identifier for the realm.
- `federation_source` - (Optional) The federation source for the provider. Defaults to `tozid`.
- `primary_realm_name` - (Required) User defined identifier for the primary realm. Defaults to value for realm_name
- `api_credential` - (Required) Server defined API Credential given by Primary Realm Federation initiation
- `primary_realm_endpoint` - (Required) Endpoint the Shadow Realm will use for communication to the Primary Realm
- `active` - (Optional) Whether the provider is active. Defaults to `true`.
- `sync`- (Optional) Whether the provider is enabled for syncing identities. Defaults to `true`.
- `sync_frequency`- (Optional) How often the identities are being synced from the Primary instance of the federation in seconds.
- `connection_id` - (Required) Server defined Unique Identitfier for a connection given by Primary Realm Federation initiation

## Attribute Reference

- `connection_id`
