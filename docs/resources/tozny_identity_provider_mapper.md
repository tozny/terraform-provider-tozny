# tozny_identity_provider_mapper Resource

Resource for Mapping roles from an External Identity Provider to Roles available in the TozID Realm (i.e. Azure AD roles to TozID roles).

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage

```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test-emails-group+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local file based credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning the use of an external identity provider
resource "tozny_identity_provider" "azure_identity_provider" {
  realm_name                = "localtest"
  display_name              = "Azure AD"
  alias                     = "azure-ad-1"
  enabled                   = true
  config {
    authorization_url       = "https://test-eidp.com/auth"
    token_url               = "https://test-eidp.com/token"
    client_auth_method      = "client_secret_post"
    client_id               = "sdsdscscscdvdfdfdfdf"
    client_secret           = "asdasdsaxcdscdcddvdvfv"
    default_scope           = "email profile openid"
  }
}

# A resource for mapping roles from Azure External Idp to Realm roles. 
resource "tozny_identity_provider_mapper" "idp_role_mapper" {
  depends_on = [
    tozny_identity_provider.azure_identity_provider,
  ]
  realm_name                    = "localtest"
  alias                         = "azure-ad-1"  
  name                          = "Azure Role Map"
  identity_provider_mapper      = "oidc-role-idp-mapper"
  config {
    sync_mode   = "FORCE"
    claim       = "roles"
    claim_value = "Test.Role"
    role        = "FirstRole"
  }
}
```

## Argument Reference

### Top-Level Arguments

- `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the Terraform provider to use when provisioning this realm identity provider. Omit if using `client_credentials_config`.
- `client_credentials_config` - (Optional) A JSON string containing Tozny client credentials for the provider to use when provisioning this realm identity provider. Omit if using `client_credentials_filepath`.
- `realm_name` - (Required) The name of the realm to associate the provider with.
- `name` - (Required) User defined name for the role mapper.
- `alias` - (Required) Alias of the identity provider that is available in the realm.
- `identity_provider_mapper` - (Required) This determines the type of mapper that is being provisioned. In this case it should default to `oidc-role-idp-mapper`.
- `config` - (Required) Configuration for the mapper that is used to determine how the roles from external idp map to realm roles.

### Config Arguments

- `sync_mode` - (Required) This determines how and when & how frequent the mapping updates the federated users of the realm. This defaults to `FORCE` to sync user roles each time they sign in to make sure its always updated with the external idp.
- `claim` - (Required) This field determines which parameter to look for in the JWT to be used for role, for example in Azure AD its `roles`.
- `claim_value` - (Required) This field denotes the role value represented in the External IDP.
- `role` - (Required) This field determines the role available in realm that is to be mapped against the external idp role represented by `claim_value`.