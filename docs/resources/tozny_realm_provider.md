# tozny_realm_provider Resource

Resource for provisioning a TozID Realm Provider for syncing identities from a federated source (i.e. an LDAP server) into the realm.

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage

```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local file based credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning the use of an external ldap server
# for providing and federating identities for a realm
resource "tozny_realm_provider" "ldap_identity_provider" {
 depends_on = [
    tozny_realm.my_organizations_realm,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  provider_type = "ldap"
  name = "LDAP Identity Provider"
  active = true
  import_identities = true
  priority = 0
  connection_settings {
    type = "ad"
    identity_name_attribute = "cn"
    rdn_attribute = "cn"
    uuid_attribute = "objectGUID"
    identity_object_classes = ["person", "organizationalPerson", "user"]
    connection_url = "ldap://test.local"
    identity_dn = "cn=users,dc=tozny,dc=local"
    authentication_type = "simple"
    bind_dn = "TOZNY\\administrator"
    bind_credential = "password"
    search_scope = 1
    trust_store_spi_mode = "ldapsOnly"
    connection_pooling = true
    pagination = true
  }
}
```

## Argument Reference

### Top-Level Arguments

* `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the Terraform provider to use when provisioning this realm identity provider. Omit if using `client_credentials_config`.
* `client_credentials_config` - (Optional) A JSON string containing Tozny client credentials for the provider to use when provisioning this realm identity provider. Omit if using `client_credentials_filepath`.
* `provider_id` - (Computed) Service defined unique identifier for the provider.
* `realm_name` - (Required) The name of the realm to associate the provider with.
* `name` - (Required) User defined name for the provider.
* `provider_type` - (Optional) The type of provider. Valid values are `ldap`. Defaults to `ldap`.
* `active` - (Optional) Whether the provider is active for the realm to sync identities from. Defaults to `true`.
* `import_identities` - (Optional) If true, LDAP identities will be imported into the realm and synced via the configured sync policies. Defaults to `true`.
* `priority` - (Optional) Priority for the provider when doing identity lookups for the realm. Lower numbers equal higher priority. Defaults to `0`.
* `connection_settings` - (Required) Settings for the realm to use when syncing identities from the provider.

### Connection Settings Arguments

* `type` - (Required) Type of the provider to connect to. Valid values are `ad` (Active Directory), `Red Hat Directory Server`, `Tivoli`, `Novell e Directory` or `other`.
* `identity_name_attribute` - (Required) Name of LDAP attribute, which is mapped as the identity name. For many LDAP server vendors it can be 'uid'. For Active directory it can be 'sAMAccountName' or 'cn'. The attribute should be filled for all LDAP identity records you want to import from LDAP to the realm.
* `rdn_attribute` - (Required) Name of LDAP attribute, which is used as RDN (top attribute) of typical user DN. Usually it's the same as Username LDAP attribute, however it's not required. For example for Active directory it's common to use 'cn' as RDN attribute when username attribute might be 'sAMAccountName'.
* `uuid_attribute` - (Required) Name of LDAP attribute, which is used as unique object identifier (UUID) for objects in LDAP. For many LDAP server vendors it's 'entryUUID' however some are different. For example for Active directory it should be 'objectGUID'. If your LDAP server really doesn't support the notion of UUID, you can use any other attribute, which is supposed to be unique among LDAP users in tree. For example 'uid' or 'entryDN'.
* `identity_object_classes` - (Required) All values of LDAP objectClass attribute for identities in LDAP. Newly created Realm identities will be written to LDAP with all those object classes and existing LDAP identity records are found just if they contain all those object classes.
* `connection_url` - (Required) URL for connecting to provider.
* `identity_dn` - (Required) Full DN of LDAP tree where your identities are. This DN is parent of LDAP identities. It could be for example 'ou=users,dc=example,dc=com' assuming that your typical identity will have DN like 'uid=john,ou=users,dc=example,dc=com'.
* `authentication_type` - (Required) LDAP Authentication type. Valid values are 'none' (anonymous LDAP authentication) or 'simple' (Bind credential + Bind password authentication).
* `bind_dn` - (Required) DN of LDAP admin, which will be used by the Realm to access LDAP server.
* `bind_credential` - (Required) Password of LDAP admin.
* `search_scope` - (Required) For one level, we search for users just in DNs specified by Identity DNs. For subtree, we search in whole of their subtree. 1= `One Level` 2 = `Subtree`.
* `trust_store_spi_mode` - (Required) Specifies whether LDAP connection will use the truststore SPI with the truststore configured for the Realm. Valid values are `always`, `never`, or `ldapsOnly`.
* `connection_pooling` - (Required) specifies whether the realm use connection pooling for accessing LDAP server.
* `pagination` - (Required) Specifies whether the LDAP server to connect to supports pagination.

## Attribute Reference

* `id` - Unique ID of the provisioned provider.
