# tozny_realm_application Resource

A resource for provisioning an Application for consumption, authentication and authorization of Realm Identities.

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage

```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local filebased credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning a token that can be used to register Tozny clients
# such as a realm broker identity
resource "tozny_client_registration_token" "realm_registration_token" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  name = "${tozny_realm.my_organizations_realm.realm_name}DefaultClientRegistrationToken"
  allowed_registration_client_types = ["general", "identity", "broker"]
  enabled = true
  one_time_use = false
}

# A resource for provisioning an identity that can be used to delegate authority for
# realm activities such as email recovery
resource "tozny_realm_broker_identity" "broker_identity" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  client_registration_token = tozny_client_registration_token.realm_registration_token.token
  realm_name = tozny_realm.my_organizations_realm.realm_name
  name = "broker${tozny_realm.my_organizations_realm.realm_name}"
  broker_identity_credentials_save_filepath = "./${tozny_realm.my_organizations_realm.realm_name}_broker_identity_credentials.json"
}

# A resource for delegating authority to another Tozny client
# (either hosted by Tozny or some other third party) to broker realm
# activities (such as email recovery).
resource "tozny_realm_broker_delegation" "allow_tozny_hosted_brokering_policy" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm_broker_identity.broker_identity,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_broker_identity_credentials_filepath = "./${tozny_realm.my_organizations_realm.realm_name}_broker_identity_credentials.json"
  use_tozny_hosted_broker = true
}

# A resource for creating an OIDC based realm application
resource "tozny_realm_application" "jenkins_oidc_application" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm.my_organizations_realm,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  client_id = "jenkins-oid-app"
  name = "Jenkins"
  active = true
  protocol = "openid-connect"
  oidc_settings {
    allowed_origins = [ "https://jenkins.acme.com/allowed" ]
    access_type = "bearer-only"
    root_url = "https://jenkins.acme.com"
    standard_flow_enabled = true
    base_url = "https://jenkins.acme.com/baseurl"
  }
}

# A resource for creating a SAML based realm application
resource "tozny_realm_application" "aws_saml_application" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
    tozny_realm.my_organizations_realm,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  client_id = "aws-saml-app"
  name = "AWS"
  active = true
  protocol = "saml"
  saml_settings {
    allowed_origins = [ "https://example.frontend.com" ]
    default_endpoint = "https://samuel/saml/iam"
    include_authn_statement = true
    include_one_time_use_condition = true
    sign_documents = true
    sign_assertions = true
    client_signature_required = true
    force_post_binding = true
    force_name_id_format = true
    name_id_format = "name_id_format"
    idp_initiated_sso_url_name = "sso_url_name"
    assertion_consumer_service_post_binding_url = "post_binding_url"
  }
}
```

## Argument Reference

### Top-Level Arguments

* `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the provider to use when provisioning this realm. For this resource either this value or both `account_username` and `account_password` must be set on the provider.
* `realm_name` - (Required) The name of the Realm to provision the Application for.
* `client_id` - (Required) The external id for clients to reference when communicating with this application.
* `application_id` - (Computed) Server defined unique identifier for the Application.
* `name` - (Required) Human readable/reference-able name for the application.
* `protocol` - (Required) What protocol (e.g. OpenIDConnect or SAML) is used to authenticate with the application. Valid values are `openid-connect`, `saml`.
* `active` - (Optional) Whether this consumer is allowed to authenticate and authorize identities. Defaults to `true`.
* `oidc_settings` - (Optional) Settings for an OIDC protocol based application. Only one of `oidc_settings` or `saml_settings` can be specified.
* `saml_settings` - (Optional) Settings for a SAML protocol based application. Only one of `saml_settings` or `oidc_settings` can be specified.

### OIDC Settings Schema

* `allowed_origins` - (Optional) The list of network locations that are allowed to be used by clients when accessing this application.
* `access_type` - (Optional) The OIDC access type.
* `root_url` - (Optional) The URL to append to any relative URLs.
* `standard_flow_enabled` - (Optional) Whether the OIDC standard flow is enabled
* `base_url` - (Optional) The OIDC base URL.

### SAML Settings Schema
`allowed_origins` - (Optional) The list of network locations that are allowed to be used by clients when accessing this application.
* `default_endpoint` - (Optional) URL used for every binding to both the SP's Assertion Consumer and Single Logout Services. This can be individually overridden for each binding and service.
* `include_authn_statement` - (Optional) Whether to include the Authn statement.
* `include_one_time_use_condition` - (Optional) Whether to include the one time use condition.
* `sign_documents` - (Optional) Whether to sign documents.
* `sign_assertions` - (Optional) Whether to sign assertions.
* `client_signature_required` - (Optional) Whether client signature is required.
* `force_post_binding` - (Optional) Whether to force POST binding.
* `force_name_id_format` - (Optional) Whether to force name ID format.
* `name_id_format` - (Optional) The name ID format
* `idp_initiated_sso_url_name` - (Optional) The IDP initiated SSO URL name.
* `assertion_consumer_service_post_binding_url` - (Optional) The assertion consumer service post bind URL.

## Attribute Reference

* `id` - Server defined unique identifier for the Application.
