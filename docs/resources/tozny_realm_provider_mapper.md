# tozny_realm_provider_mapper Resource

Resource for provisioning a TozID Realm Provider Mapper for mapping attributes of synced identities from a federated source (i.e. an LDAP server) into the realm.

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage

```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local file based credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning the use of an external ldap server
# for providing and federating identities for a realm
resource "tozny_realm_provider" "ldap_identity_provider" {
 depends_on = [
    tozny_realm.my_organizations_realm,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  provider_type = "ldap"
  name = "LDAP Identity Provider"
  active = true
  import_identities = true
  priority = 0
  connection_settings {
    type = "ad"
    identity_name_attribute = "cn"
    rdn_attribute = "cn"
    uuid_attribute = "objectGUID"
    identity_object_classes = ["person", "organizationalPerson", "user"]
    connection_url = "ldap://test.local"
    identity_dn = "cn=users,dc=tozny,dc=local"
    authentication_type = "simple"
    bind_dn = "TOZNY\\administrator"
    bind_credential = "password"
    search_scope = 1
    trust_store_spi_mode = "ldapsOnly"
    connection_pooling = true
    pagination = true
  }
}

# A resource for configuring the mapping of identities values synced
# from an ldap identity provider
resource "tozny_realm_provider_mapper" "ldap_group_mapper" {
  depends_on = [
    tozny_realm_provider.ldap_identity_provider,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = tozny_realm.my_organizations_realm.realm_name
  provider_id = tozny_realm_provider.ldap_identity_provider.provider_id
  provider_type = "group-ldap-mapper"
  name = "ldap-group-mapper"
  groups_dn = "ou=groups,dc=tozny,dc=local"
  group_name_attribute = "cn"
  group_object_classes = ["group"]
  preserve_group_inheritance = true
  ignore_missing_groups = false
  member_of_attribute = "memberOf"
  membership_attribute = "member"
  membership_attribute_type = "DN"
  mode = "READ_ONLY"
  membership_identity_attribute = "cn"
  identity_groups_retrieval_strategy = "LOAD_GROUPS_BY_MEMBER_ATTRIBUTE"
  drop_missing_groups_on_sync = false
}
```

## Argument Reference

### Top-Level Arguments

* `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the Terraform provider to use when provisioning this realm identity provider mapper. Omit if using `client_credentials_config`.
* `client_credentials_config` - (Optional) A JSON string containing Tozny client credentials for the provider to use when provisioning this realm identity provider mapper. Omit if using `client_credentials_filepath`.
* `provider_mapper_id` - (Computed) Service defined unique identifier for the provider mapper.
* `provider_id` - (Required) Service defined unique identifier for the provider to associate the mapper with.
* `realm_name` - (Required) The name of the realm to associate the provider mapper with.
* `name` - (Required) User defined name for the provider mapper.
* `provider_type` - (Required) The type of the provider mapper. Valid values are `msad-user-account-control-mapper`, `msad-lds-user-account-control-mapper`, `group-ldap-mapper`, `user-attribute-ldap-mapper`, `role-ldap-mapper`, `hardcoded-ldap-role-mapper`, `full-name-ldap-mapper`, `hardcoded-ldap-group-mapper`, `hardcoded-ldap-attribute-mapper`.
* `groups_dn` - (Required) LDAP DN where are groups of this tree saved. For example 'ou=groups,dc=example,dc=org'.
* `group_name_attribute` - (Required) Name of LDAP attribute, which is used in group objects for name and RDN of group. Usually it will be 'cn' . In this case typical group/role object may have DN like 'cn=Group1,ou=groups,dc=example,dc=org'.
* `group_object_classes` - (Required) Object class (or classes) of the group object. In typical LDAP deployment it could be 'groupOfNames' . In Active Directory it's usually 'group'.
* `preserve_group_inheritance` - (Required) Flag whether group inheritance from LDAP should be propagated to the Realm. If false, then all LDAP groups will be mapped as flat top-level groups in the Realm. Otherwise group inheritance is preserved into the Realm, but the group sync might fail if LDAP structure contains recursions or multiple parent groups per child groups.
* `ignore_missing_groups` - (Required) Whether missing groups in the hierarchy should be ignored.
* `member_of_attribute` - (Required) Used just when `identity_groups_retrieval_strategy` is GET_GROUPS_FROM_USER_MEMBEROF_ATTRIBUTE . It specifies the name of the LDAP attribute on the LDAP identity, which contains the groups, which the identity is a member of. Usually it will be 'memberOf'.
* `membership_attribute` - (Required) Name of LDAP attribute on group, which is used for membership mappings. Usually it will be 'member' .However when 'Membership Attribute Type' is 'UID' then 'Membership LDAP Attribute' could be typically 'memberUid'.
* `membership_attribute_type` - (Required) DN means that LDAP group has it's members declared in form of their full DN. For example 'member: uid=john,ou=users,dc=example,dc=com' . UID means that LDAP group has it's members declared in form of pure user uids. For example 'memberUid: john'. Valid values are `DN` or `UID`.
* `membership_identity_attribute` - (Required) Used just if Membership Attribute Type is UID. It is name of LDAP attribute on user, which is used for membership mappings. Usually it will be 'uid' . For example if value of 'Membership User LDAP Attribute' is 'uid' and LDAP group has 'memberUid: john', then it is expected that particular LDAP user will have attribute 'uid: john'.
* `mode` - (Required) LDAP_ONLY means that all group mappings of users are retrieved from LDAP and saved into LDAP. READ_ONLY is Read-only LDAP mode where group mappings are retrieved from both LDAP and DB and merged together. New group joins are not saved to LDAP but to the Realm. IMPORT is Read-only LDAP mode where group mappings are retrieved from LDAP just at the time when user is imported from LDAP and then they are saved to the realm.
* `identity_groups_retrieval_strategy` - (Required) Specify how to retrieve groups of user. LOAD_GROUPS_BY_MEMBER_ATTRIBUTE means that roles of user will be retrieved by sending LDAP query to retrieve all groups where 'member' is our user. GET_GROUPS_FROM_USER_MEMBEROF_ATTRIBUTE means that groups of user will be retrieved from 'memberOf' attribute of our user. Or from the other attribute specified by 'Member-Of LDAP Attribute' . LOAD_GROUPS_BY_MEMBER_ATTRIBUTE_RECURSIVELY is applicable just in Active Directory and it means that groups of user will be retrieved recursively with usage of LDAP_MATCHING_RULE_IN_CHAIN Ldap extension.
* `drop_missing_groups_on_sync` - (Required) If this flag is true, then during sync of groups from LDAP to the Realm, we will keep just those Realm groups, which still exists in LDAP. Rest will be deleted.

## Attribute Reference

* `id` - Unique ID of the provisioned provider mapper.
