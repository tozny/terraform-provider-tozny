# tozny_identity_provider Resource

Resource for provisioning an External Identity Provider for TozID Realm for allowing users to sign-in to realm through external OIDC Id providers (i.e. Azure AD, Okta).

This resource requires that the account username and password be supplied to the provider either via explicit provider settings or file based credentials.

## Example Usage

```hcl
# Include the Tozny Terraform provider
provider "tozny" {
  api_endpoint = "http://platform.local.tozny.com:8000"
  account_username = "test-emails-group+${random_string.account_username_salt.result}@tozny.com"
}

# Generate a random string for use in creating
# accounts across environments or executions conflict free
resource "random_string" "account_username_salt" {
  length = 8
  special = false
}

# Generate a random string for use in creating
# realms across environments or executions conflict free
resource "random_string" "random_realm_name" {
  length = 8
  special = false
}

# Local variables for defining where to store and find local Tozny client credentials
locals {
  tozny_client_credentials_filepath = "./tozny_client_credentials.json"
}

# A resource for provisioning a Tozny account using Terraform generated
# credentials that are saved to user specified filepath for reuse upon success.
resource "tozny_account" "autogenerated_tozny_account" {
  autogenerate_account_credentials = true
  client_credentials_save_filepath = local.tozny_client_credentials_filepath
}

# A resource for provisioning a TozID Realm
# using local file based credentials for a Tozny Client with permissions to manage Realms.
resource "tozny_realm" "my_organizations_realm" {
  # Block on and use client credentials generated from the provisioned account
  depends_on = [
    tozny_account.autogenerated_tozny_account,
  ]
  client_credentials_filepath = local.tozny_client_credentials_filepath
  realm_name = random_string.random_realm_name.result
  sovereign_name = "Administrator"
}

# A resource for provisioning the use of an external identity provider
resource "tozny_identity_provider" "azure_identity_provider" {
  realm_name                = "localtest"
  display_name              = "Azure AD"
  alias                     = "azure-ad-1"
  enabled                   = true
  config {
    authorization_url       = "https://test-eidp.com/auth"
    token_url               = "https://test-eidp.com/token"
    client_auth_method      = "client_secret_post"
    client_id               = "sdsdscscscdvdfdfdfdf"
    client_secret           = "asdasdsaxcdscdcddvdvfv"
    default_scope           = "email profile openid"
  }
}
```

## Argument Reference

### Top-Level Arguments

- `client_credentials_filepath` - (Optional) The filepath to Tozny client credentials for the Terraform provider to use when provisioning this realm identity provider. Omit if using `client_credentials_config`.
- `client_credentials_config` - (Optional) A JSON string containing Tozny client credentials for the provider to use when provisioning this realm identity provider. Omit if using `client_credentials_filepath`.
- `realm_name` - (Required) The name of the realm to associate the provider with.
- `display_name` - (Required) User defined name for the provider.
- `alias` - (Required) User defined unique identifier for the provider.
- `active` - (Optional) Whether the provider is active for the realm to allow users to sign in. Defaults to `true`.
- `config` - (Required) OpenID Connect Configuration for the provider that is used when connecting to external identity provider.

### Config Arguments

- `authorization_url` - (Required) The authorization endpoint found in the openid configuration of the external identity provider.
- `token_url` - (Required) The token endpoint found in the openid configuration of the external identity provider.
- `client_auth_method` - (Required) Determines how the client secret is sent to the external identity provider, can be one of the following 
    * `client_secret_post` - Client Secret sent as Post 
    * `client_secret_basic` - Client Secret sent as Basic Auth 
    * `client_secret_jwt` - Client Secret as JWT
    * `private_key_jwt` - JWT Signed with private key
- `client_id` - (Required) Client ID obtained from the External Identity Provider.
- `client_secret` - (Required) Client Secret obtained from the External Identity Provider.
- `default_scope` - (Required) `email profile openid` scopes required by the realm or client applications for accessing information about the user.